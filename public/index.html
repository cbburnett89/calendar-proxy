<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>calendar-proxy</h2>
    </div>
    <ul class="sidebar-menu">
      <li class="active">Dashboard</li>
      <li>Events</li>
      <li>Settings</li>
      <li>Help</li>
    </ul>
  </div>
  <div class="main-content">
    <header>
      <h1>Calendar</h1>
      <div class="user-info">
        <span class="user-avatar">CB</span>
        <span class="user-name">cbburnett89</span>
      </div>
    </header>
    <section class="calendar-section">
      <ul id="calendar-events">
        <li>Loading calendar events...</li>
      </ul>
      <div id="calendar-error" style="display:none;color:#ff7070;margin-top:16px;text-align:center;">
        Failed to load calendar. Please check your .ics URL and server logs.
      </div>
    </section>
  </div>
  <script>
    // Fetch and display calendar events from the server-side proxy
    async function fetchCalendar() {
      try {
        const response = await fetch('/api/calendar');
        if (!response.ok) throw new Error('Failed to fetch');
        const icsData = await response.text();
        const jcalData = ICAL.parse(icsData);
        const comp = new ICAL.Component(jcalData);
        const events = comp.getAllSubcomponents('vevent')
          .map(event => new ICAL.Event(event))
          .filter(ev => ev.startDate && new Date(ev.startDate.toString()) >= new Date(new Date().setHours(0,0,0,0)))
          .sort((a, b) => new Date(a.startDate.toString()) - new Date(b.startDate.toString()));
        let html = '';
        const maxEvents = 7;
        if (events.length === 0) html = '<li>No upcoming events found.</li>';
        events.slice(0, maxEvents).forEach(ev => {
          const dateObj = new Date(ev.startDate.toString());
          const month = dateObj.toLocaleString(undefined, { month: 'short' });
          const day = dateObj.getDate();
          const hour = dateObj.getHours();
          const min = dateObj.getMinutes();
          let timeStr = '';
          if (hour || min)
            timeStr = ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
          html += `<li class="calendar-event">
            <div class="calendar-date">${month}<br><span style="font-size:1.3rem">${day}</span>${timeStr}</div>
            <div class="calendar-title">${ev.summary || '(No Title)'}</div>
          </li>`;
        });
        document.getElementById('calendar-events').innerHTML = html;
        document.getElementById('calendar-error').style.display = "none";
      } catch (err) {
        document.getElementById('calendar-events').innerHTML = '';
        document.getElementById('calendar-error').style.display = "block";
      }
    }
    fetchCalendar();
    setInterval(fetchCalendar, 1000 * 60 * 5); // Optionally, refresh every 5 minutes
  </script>
</body>
</html>